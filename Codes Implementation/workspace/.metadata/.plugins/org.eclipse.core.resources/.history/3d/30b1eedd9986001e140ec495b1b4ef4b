<%@ page language="java" contentType="text/html;charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.sql.*" %>
<%@ page import="java.io.*" %>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="userdetail.css">
    <title>CARDX - User Detail</title>
</head>

<body>

    <header>
        <h1>CARDX - User Detail</h1>
    </header>

    <div class="user-card">
        <div class="user-photo">
            <img src="https://source.unsplash.com/random/250x250?person" alt="User Photo">
            <div>
                <a href="editprofile.jsp"><button class="edit-button">Edit-Profile</button></a>
            </div>
        </div>
        <div class="user-details">
            <table>
                <tr>
                    <td>Name:</td>
                    <td><%=name %></td>
                </tr>
                <tr>
                    <td>Address:</td>
                    <td><%=area %></td>
                </tr>
                <tr>
                    <td>City:</td>
                    <td><%=area1 %></td>
                </tr>
                <tr>
                    <td>Pincode:</td>
                    <td><%=pincode1 %></td>
                </tr>
                <tr>
                    <td>Phone Number:</td>
                    <td><%=mobile1 %></td>
                </tr>
                <tr>
                    <td>Cars Bought:</td>
                    <td>10</td>
                </tr>
                <tr>
                    <td>Cars Sold:</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td>Cars Rented:</td>
                    <td>3</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Bargain Requests section -->
    <section class="bargain-requests">

        <!-- Sent - Bargain Requests -->
        <div class="bargain-reqtitle">
            <h1>Sent - Bargain Requests</h1>
        </div>

        <%
        try {
            int a = 100;
            Class.forName("org.postgresql.Driver");
            Connection connection = DriverManager.getConnection("jdbc:postgresql://localhost:5432/postgres",
                    "postgres", "jay");

            PreparedStatement preparedStatement = connection
                    .prepareStatement("SELECT * FROM bargain_request WHERE customer_id = ?");
            preparedStatement.setString(1, (String) session.getAttribute("email"));
            ResultSet resultSet = preparedStatement.executeQuery();

            while (resultSet.next()) {
                a++;
        %>
                <div class="request">
                    <div class="user-details">
                        <img src="https://source.unsplash.com/random/<%= a %>x150?person" alt="User Avatar"
                            class="user-avatar">
                        <div class="user-info">
                            <h2>Robert</h2>
                            <p>Price: <%= resultSet.getString("price") %></p>
                            <p>Request_time: <%= resultSet.getString("request_time") %></p>
                        </div>
                    </div>
                    <div class="reqstatus">
                        <h1>
                            <%
                            String carId = resultSet.getString("car_id");
                            String query = "SELECT buyer_id FROM public.old_car WHERE car_id = ?";
                            try (PreparedStatement oldCarPreparedStatement = connection.prepareStatement(query)) {
                                oldCarPreparedStatement.setString(1, carId);
                                try (ResultSet oldCarResultSet = oldCarPreparedStatement.executeQuery()) {
                                    if (oldCarResultSet.next()) {
                                        String buyerId = oldCarResultSet.getString("buyer_id");
                                        if (buyerId == null) {
                            %>
                                            Pending
                            <%
                                        } else if (buyerId.equals(session.getAttribute("email"))) {
                            %>
                                            Accepted
                            <%
                                        } else {
                            %>
                                            Rejected
                            <%
                                        }
                            %>
                        </h1>
                    </div>
                </div>
        <%
                    } else {
                        // Handle the case where there is no corresponding record in old_car for the given car_id
                    }
                }
            } catch (SQLException e) {
                // Handle any SQL exception for old_car
                e.printStackTrace();
            }
        }
        } catch (ClassNotFoundException | SQLException e) {
            // Handle any exceptions related to database connection or query
            e.printStackTrace();
        }
        %>

        <div class="bargain-reqtitle">
            <h1>Received - Bargain Requests</h1>
        </div>

        <!-- Example bargain request 2 -->
        <div class="request">
            <div class="user-details">
                <img src="https://source.unsplash.com/random/140x140?person" alt="User Avatar"
                    class="user-avatar">
                <div class="user-info">
                    <h2>Anthony</h2>
                    <p>Occupation: Doctor</p>
                    <p>Location: LAHospital</p>
                </div>
            </div>
            <div class="buttons">
                <button class="accept-button">Accept</button>
                <button class="reject-button">Reject</button>
            </div>
        </div>

        <!-- Add more requests as needed
