package backand;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
@WebServlet("/add-rentcar")
public class adminAddRentCar extends jakarta.servlet.http.HttpServlet{
	private int getMaxOldCarId(Connection connection) throws SQLException {
        String sql = "SELECT MAX(car_id) FROM public.rental_car";
        try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
            try (var resultSet = preparedStatement.executeQuery()) {
                if (resultSet.next()) {
                    return resultSet.getInt(1)+1;
                }
            }
        }
        return 1;
    }
	
	
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		PrintWriter out= response.getWriter();
		try {
			
			response.setContentType("text/html");
            Class.forName("org.postgresql.Driver");
			String url = "jdbc:postgresql://localhost:5432/postgres";
            String username = "postgres";
            String password2 = "jay";
            
            Connection con = DriverManager.getConnection(url, username, password2);
            
            String model = request.getParameter("Model");
            String company = request.getParameter("company");
            String price = request.getParameter("Price");
            String colour = request.getParameter("colour");
            String fuel = request.getParameter("fuel");
            String rent1="rent";
            
            PreparedStatement ps = con.prepareStatement("select * from car_company where model=? and company_name=? ");
            ps.setString(1,model);
            ps.setString(2,company);
            
            ResultSet rs=ps.executeQuery();
            
            int flag=0;
            if(rs.next())
            {
            	flag=1;
            }
            
            if(flag==0)
            {
            	 PreparedStatement ps1 = con.prepareStatement("insert into car_company values(?,?) ");
                 ps1.setString(1,model);
                 ps1.setString(2,company);
                 ps1.executeUpdate();
            }
            
            int carid=getMaxOldCarId(con);
            PreparedStatement ps2 = con.prepareStatement("insert into rental_car(rental_car_id) values(?) ");
            ps2.setInt(1, carid);
            
            
            PreparedStatement ps3 = con.prepareStatement("insert into car(car_id,price,colour,model,fuel_type,car_type) values(?,?,?,?,?,?) ");
            ps3.setInt(1, carid);
            ps3.setInt(2,Integer.parseInt(price));
            ps3.setString(3, colour);
            ps3.setString(4,model);
            ps3.setString(5, fuel);
            ps3.setString(6, rent1);
            
            ps2.executeUpdate();
            ps3.executeUpdate();
            
            RequestDispatcher rd=request.getRequestDispatcher("/admin.jsp");
       	    rd.include(request, response);
        	
            
            
            
		}
		
		catch (ClassNotFoundException e) {
		    e.printStackTrace();
		    System.out.println("PostgreSQL JDBC driver not found");
		} catch (SQLException e) {
			//response.setContentType("text/html");
			out.print("<h2 style='color:red'> "+e.getMessage() +"</h2>");
			RequestDispatcher rd=request.getRequestDispatcher("/admin.jsp");
			rd.include(request, response);
		}
		
	}
}
