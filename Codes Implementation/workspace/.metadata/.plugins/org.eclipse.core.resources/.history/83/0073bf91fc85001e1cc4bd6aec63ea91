package backand;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.SQLException;

import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

@WebServlet("/sellcar")
public class sellcar extends HttpServlet {
	
	private int getMaxOldCarId(Connection connection) throws SQLException {
        String sql = "SELECT MAX(car_id) FROM public.old_car";
        try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
            try (var resultSet = preparedStatement.executeQuery()) {
                if (resultSet.next()) {
                    return resultSet.getInt(1)+1;
                }
            }
        }
        return 1;
    }
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		PrintWriter out= response.getWriter();
		response.setContentType("text/html");
		try {
        	//out.print("hello");
			
			response.setContentType("text/html");
            Class.forName("org.postgresql.Driver");

            String url = "jdbc:postgresql://localhost:5432/postgres";
            String username = "postgres";
            String password2 = "jay";
            
            Connection con = DriverManager.getConnection(url, username, password2);
            String model = request.getParameter("Model");
            String company = request.getParameter("Company");
            int price = Integer.parseInt(request.getParameter("Price"));
            int year = Integer.parseInt(request.getParameter("year"));
            int  kilometer = Integer.parseInt(request.getParameter("kilometer"));
            String description = request.getParameter("description");
            String fuel_type = request.getParameter("fuel_type");
            String colour = request.getParameter("colour");
            
            
            int car_id=getMaxOldCarId( con ) ;
            PreparedStatement ps ;
            ps=con.prepareStatement("insert into car_company ( model,company_name)values(?,?) ");
            
            ps.setString(1, model);
            ps.setString(2, company);
            ps.executeUpdate();
            ps=con.prepareStatement("insert into old_car ( car_id, year , km,  description)values(?,?,?,?) ");
            
            ps.setInt(1, car_id);
            ps.setInt(2, year);
            ps.setInt(3, kilometer);
            ps.setString(4, description);
            ps.executeUpdate();
            
            ps=con.prepareStatement("insert into car ( car_id, price , colour,  model,fuel_type,car_type)values(?,?,?,?,?,?) ");
            ps.setInt(1, car_id);
            ps.setInt(2, price);
            ps.setString(3, colour);
            ps.setString(4, model);
            ps.setString(5, fuel_type);
            ps.setString(6, "old");
            ps.executeUpdate();
            RequestDispatcher rd=request.getRequestDispatcher("/homepage.jsp");
       	 rd.include(request, response);
		}
		catch (ClassNotFoundException e) {
            e.printStackTrace();
            System.out.println("PostgreSQL JDBC driver not found");
        } catch (SQLException e) {
        	//response.setContentType("text/html");
        	out.print("<h2 style='color:red'> "+e.getMessage() +"</h2>");
        	RequestDispatcher rd=request.getRequestDispatcher("/index.jsp");
        	rd.include(request, response);
        }

	
	
	}

}
